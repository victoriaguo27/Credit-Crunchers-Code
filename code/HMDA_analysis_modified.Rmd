---
title: "HMDA_analysis_modified"
author: "Hartej Singh"
date: "2024-04-03"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Packages
```{r}
library(ggplot2)
library(dplyr)
library(rvest)
```

# Data Prep - data cleaning of the original random sample of 50,000 observations and adding new variables for CPI-U, Unemployment Rate, and 
# Per Capita Real GDP

## This data set has been modified with the following changes - a) a new column for loan to income ratio, i.e. loan_amount_000s / applicant_income_000s ; b) unemployment_rate for each race (asian, black, and white); c) fed_funds_avg_yield

## corrections to be made in the current data set - a) right to loan to income ration is taken as ratio of hud_median_family_income / loan_amount_000s, b) have seperate columns for unemployment rate for asian, black, and white - need this as a single column of unmeplyment rate for the 3 races, c) fed_funds_avg_yield - this is federal funds rate for each year from 2007 to 2012 (this is fine)

```{r}
# Load in HMDA Data
HMDA<-read.csv("newHMDAdata.csv")

# Converting to factor variables
HMDA$state_abbr <- factor(HMDA$state_abbr)
HMDA$agency_abbr <- factor(HMDA$agency_abbr)
HMDA$loan_type_name <- factor(HMDA$loan_type_name)
HMDA$property_type_name <- factor(HMDA$property_type_name)
HMDA$loan_purpose_name <- factor(HMDA$loan_purpose_name)
HMDA$preapproval_name <- factor(HMDA$preapproval_name)
HMDA$action_taken_name <- factor(HMDA$action_taken_name)
HMDA$applicant_race_name_1 <- factor(HMDA$applicant_race_name_1)
HMDA$applicant_sex_name <- factor(HMDA$applicant_sex_name)


# Reducing applicant_race_name_1 to only 2 levels - "White", "Black", "Asian"
HMDA <- mutate(HMDA,
              app_race = case_when(
                applicant_race_name_1 %in% c("Asian") ~ "Asian",
                applicant_race_name_1 %in% c("Black or African American") ~ "Black",
                applicant_race_name_1 %in% c("White") ~ "White",
                TRUE ~ NA_character_
              )
)

# Converting app_race to a factor variable
HMDA$app_race <- factor(HMDA$app_race)


# Reducing applicant_sex_name to Male and Female
HMDA$applicant_sex_name <- factor(
  HMDA$applicant_sex_name,
  levels = c("Male", "Female")
)

# Converting applicant_sex_name to a factor variable
HMDA$applicant_sex_name <- factor(HMDA$applicant_sex_name)


# Create unemployment rates column
unemployment_rates <- data.frame(
  state_abbr = c(rep('VA', 6), rep('CA', 6)),
  as_of_year = rep(2007:2012, 2),
  unemployment_rate = c(3.0, 3.9, 6.7, 6.9, 6.4, 5.9, 5.4, 7.2, 11.3, 12.4, 11.8, 10.4)
)

# Join the unemployment rates with the HMDA data
HMDA <- merge(HMDA, unemployment_rates, by = c("state_abbr", "as_of_year"), all.x = TRUE)

# Adding a column for per capita real GDP for VA and CA (state-level)
HMDA <- HMDA %>%
  mutate(
    Per_Cap_GDP = case_when(
      state_abbr == "VA" & as_of_year == 2007 ~ 52676,
      state_abbr == "VA" & as_of_year == 2008 ~ 52140,
      state_abbr == "VA" & as_of_year == 2009 ~ 51772,
      state_abbr == "VA" & as_of_year == 2010 ~ 52370,
      state_abbr == "VA" & as_of_year == 2011 ~ 52145,
      state_abbr == "VA" & as_of_year == 2012 ~ 51967,
      state_abbr == "CA" & as_of_year == 2007 ~ 55011,
      state_abbr == "CA" & as_of_year == 2008 ~ 54733,
      state_abbr == "CA" & as_of_year == 2009 ~ 51830,
      state_abbr == "CA" & as_of_year == 2010 ~ 51878,
      state_abbr == "CA" & as_of_year == 2011 ~ 52037,
      state_abbr == "CA" & as_of_year == 2012 ~ 52851,
      TRUE ~ NA_integer_  # for any other cases
    )
  )

# Adding a column for average annual CPI-U (National level)
HMDA <- HMDA %>%
  mutate(
    CPI = case_when(
      as_of_year == 2007 ~ 207.3,
      as_of_year == 2008 ~ 215.3,
      as_of_year == 2009 ~ 214.5,
      as_of_year == 2010 ~ 218,
      as_of_year == 2011 ~ 225,
      as_of_year == 2012 ~ 230,
      TRUE ~ NA_integer_ 
    )
  )

# Removing unwanted columns
HMDA <- select(HMDA, -agency_abbr, -owner_occupancy_name, -preapproval_name, 
               -co_applicant_race_name_1, -co_applicant_sex_name, -purchaser_type_name, 
               -hud_median_family_income, -hoepa_status_name, -census_tract_number, -applicant_ethnicity_name,
               -co_applicant_ethnicity_name, -unemployment_rate, -income_to_loan_ratio)


# Adding a new column for loan_amount_000s / applicant_income_000s

HMDA$loan_to_income <- HMDA$loan_amount_000s / HMDA$applicant_income_000s

# Getting the unemployment by race in a single column

HMDA <- HMDA %>%
  mutate(unemployment_rate = case_when(
    app_race == "White" ~ unemployment_white,
    app_race == "Black" ~ unemployment_black,
    app_race == "Asian" ~ unemployment_asian,
    TRUE ~ NA_real_ # This line handles cases where app_race is none of the above
  ))

## Now, we can remove the columns for unemployment_white, unemployment_black, and unemployment_asian

HMDA <- select(HMDA, -unemployment_white, -unemployment_black, -unemployment_asian)

# Renaming the level of "One-to-four family dwelling" to "Traditional housing" in the variable, property_type_name
levels(HMDA$property_type_name)[levels(HMDA$property_type_name) == "One-to-four family dwelling (other than manufactured housing)"] <- "Traditional housing"

# Removing na values
HMDA <- na.omit(HMDA)
```


## Subsetting our data for females and recovery
```{r}
# Step 1: Filter the data for female applicants and the Recovery period
HMDA_female_Recovery <- HMDA %>%
 filter(period == "Recovery" & applicant_sex_name == "Female")
```

## EDA for the subsetted data (female applicants and recovery period) - Note: also refer to EDA for our random sample of 50,000 observations we did before (it's on the drive under the EDA folders)
```{r}
#EDA - for female applicants and the Recovery period
#1) summary table
summary(HMDA_female_Recovery)
# action_taken_name is a balanced data set with #Loan denied = 2,121 and #Loan originated = 2,812

# exploring the relation for interactions that I have added

#i) interaction between applicant_income_000s and property_type_name
ggplot(HMDA_female_Recovery, aes(x = property_type_name, y = applicant_income_000s, fill = action_taken_name)) +
  geom_violin(scale = "width", trim = FALSE) +
  labs(title = "Violin Plot of Applicant Income by Property Type and Action Taken",
       x = "Property Type",
       y = "Applicant Income",
       fill = "Action Taken") +
  theme_minimal() +
  scale_fill_manual(values = c("Loan originated" = "blue", "Loan denied" = "red"))

##ii) interaction between applicant_income_000s and state_abbr
ggplot(HMDA_female_Recovery, aes(x = state_abbr, y = applicant_income_000s, fill = action_taken_name)) +
  geom_violin(scale = "width", trim = FALSE) +
  labs(title = "Violin Plot of Applicant Income by State and Action Taken",
       x = "State",
       y = "Applicant Income",
       fill = "Action Taken") +
  theme_minimal() +
  scale_fill_manual(values = c("Loan originated" = "blue", "Loan denied" = "red"))

##iii) interaction between applicant_income_000s and loan_purpose_name
ggplot(HMDA_female_Recovery, aes(x = loan_purpose_name, y = applicant_income_000s, fill = action_taken_name)) +
  geom_violin(scale = "width", trim = FALSE) +
  labs(title = "Violin Plot of Applicant Income by Loan Purpose and Action Taken",
       x = "Property Type",
       y = "Applicant Income",
       fill = "Action Taken") +
  theme_minimal() +
  scale_fill_manual(values = c("Loan originated" = "blue", "Loan denied" = "red"))

##iv) interaction between per capita GDP and CPI
ggplot(HMDA_female_Recovery, aes(x = Per_Cap_GDP, y = CPI, color = action_taken_name)) +
  geom_smooth(method = "lm", se = F) +
  labs(title = "Per Capita GDP vs. CPI",
       x = "Per Capita GDP",
       y = "CPI",
       color = "Action Taken") +
  theme_minimal()

##v) Unemployment Rate and Approval Rate

# Calculate approval rate
approval_data <- HMDA %>%
  group_by(state_abbr, period, action_taken_name, applicant_race_name_1, unemployment_rate) %>%
  summarize(count = n()) %>%
  tidyr::spread(action_taken_name, count, fill = 0) %>%
  mutate(approval_rate = `Loan originated` / (`Loan originated` + `Loan denied`) * 100)


ggplot(approval_data, aes(x = unemployment_rate, y = approval_rate)) +
  geom_point() +
  geom_smooth(method = "lm", se = F) +
  labs(title = "Unemployment Rate vs HMDA Approval Rate",
       x = "Unemployment Rate",
       y = "Approval Rate")

#4) exploring the relations between categorical variables
# 1) state_abbr and action_taken_name
table_result1 <- table(HMDA_female_Recovery$state_abbr, HMDA_female_Recovery$action_taken_name)
print(table_result1)

# 2) loan_type_name and action_taken_name
table_result2 <- table(HMDA_female_Recovery$loan_type_name, HMDA_female_Recovery$action_taken_name)
print(table_result2)

# 3) property_type_name and action_taken_name
table_result3 <- table(HMDA_female_Recovery$property_type_name, HMDA_female_Recovery$action_taken_name)
print(table_result3)

# 4) loan_purpose_name and action_taken_name
table_result4 <- table(HMDA_female_Recovery$loan_purpose_name, HMDA_female_Recovery$action_taken_name)
print(table_result4)

# 5) app_race and action_taken_name
table_result5 <- table(HMDA_female_Recovery$app_race, HMDA_female_Recovery$action_taken_name)
print(table_result5)

## You can summarize the above tables into 1 comprehensive table
```

## i) Recovery Period

```{r}
# Step 3: Logistic Regression

# Having Black as the reference class
HMDA_female_Recovery$app_race <- relevel(HMDA_female_Recovery$app_race, ref = "Black")

## Changes from previous analysis - I will remove applicant_income_000s as control since adding loan_to_income as a replacement (this also means new EDA). Also, I will add a new control for fed_funds_avg_yield (do EDA for this also)

# Fit a logistic regression model with "action_taken_name" as the response variable
model <- glm(action_taken_name ~ state_abbr + loan_type_name + property_type_name +
             loan_purpose_name + loan_to_income + app_race + CPI + unemployment_rate + Per_Cap_GDP  + loan_to_income*property_type_name + loan_to_income*state_abbr + loan_to_income * loan_purpose_name + Per_Cap_GDP * CPI + fed_funds_avg_yield, data = HMDA_female_Recovery, family = binomial)

# Step 4: Hypothesis Testing
# Get a summary of the model to check p-values
summary(model)
```

app_raceAsian and app_raceWhite no longer significant, but comparison between VA and CA significant (coefficient - 0.6953; with CA as the reference class)

```{r}
exp(0.6953)
```
ii) Recession

## Subsetting for females and recession
```{r}
# Step 1: Subsetting the data
HMDA_female_Recession <- HMDA %>%
  filter(period == "Recession" & applicant_sex_name == "Female")
```

```{r}
#Step 2 - additional EDA for subsetted data of females and recession

#EDA - for female applicants and the Recession period
#1) summary table
summary(HMDA_female_Recession)
# action_taken_name is a balanced data set with #Loan denied = 4,193 and #Loan originated = 3,020

## exploring the relation for interactions

#i) interaction between applicant_income_000s and property_type_name
ggplot(HMDA_female_Recession, aes(x = property_type_name, y = applicant_income_000s, fill = action_taken_name)) +
  geom_violin(scale = "width", trim = FALSE) +
  labs(title = "Violin Plot of Applicant Income by Property Type and Action Taken",
       x = "Property Type",
       y = "Applicant Income",
       fill = "Action Taken") +
  theme_minimal() +
  scale_fill_manual(values = c("Loan originated" = "blue", "Loan denied" = "red"))

##ii) interaction between applicant_income_000s and state_abbr
ggplot(HMDA_female_Recession, aes(x = state_abbr, y = applicant_income_000s, fill = action_taken_name)) +
  geom_violin(scale = "width", trim = FALSE) +
  labs(title = "Violin Plot of Applicant Income by State and Action Taken",
       x = "Property Type",
       y = "Applicant Income",
       fill = "Action Taken") +
  theme_minimal() +
  scale_fill_manual(values = c("Loan originated" = "blue", "Loan denied" = "red"))

##iii) interaction between applicant_income_000s and loan_purpose_name
ggplot(HMDA_female_Recession, aes(x = loan_purpose_name, y = applicant_income_000s, fill = action_taken_name)) +
  geom_violin(scale = "width", trim = FALSE) +
  labs(title = "Violin Plot of Applicant Income by Loan Purpose and Action Taken",
       x = "Property Type",
       y = "Applicant Income",
       fill = "Action Taken") +
  theme_minimal() +
  scale_fill_manual(values = c("Loan originated" = "blue", "Loan denied" = "red"))

##iv) interaction between per capita GDP and CPI
ggplot(HMDA_female_Recession, aes(x = Per_Cap_GDP, y = CPI, color = action_taken_name)) +
  geom_smooth(method = "lm") +
  labs(title = "Scatter Plot of Per Capita GDP vs. CPI",
       x = "Per Capita GDP",
       y = "CPI",
       color = "Action Taken") +
  theme_minimal()

#4) exploring the relations between categorical variables
# 1) state_abbr and action_taken_name
table_result1 <- table(HMDA_female_Recession$state_abbr, HMDA_female_Recession$action_taken_name)
print(table_result1)

# 2) loan_type_name and action_taken_name
table_result2 <- table(HMDA_female_Recession$loan_type_name, HMDA_female_Recession$action_taken_name)
print(table_result2)

# 3) property_type_name and action_taken_name
table_result3 <- table(HMDA_female_Recession$property_type_name, HMDA_female_Recession$action_taken_name)
print(table_result3)

# 4) loan_purpose_name and action_taken_name
table_result4 <- table(HMDA_female_Recession$loan_purpose_name, HMDA_female_Recession$action_taken_name)
print(table_result4)

# 5) app_race and action_taken_name
table_result5 <- table(HMDA_female_Recession$app_race, HMDA_female_Recession$action_taken_name)
print(table_result5)
```

```{r}
# Step 3: Logistic Regression

# Having Black as the reference class
HMDA_female_Recession$app_race <- relevel(HMDA_female_Recession$app_race, ref = "Black")

# Fit a logistic regression model with "action_taken_name" as the response variable
model <- glm(action_taken_name ~ state_abbr + loan_type_name + property_type_name +
             loan_purpose_name + loan_to_income + app_race + CPI + unemployment_rate + Per_Cap_GDP  + loan_to_income*property_type_name + loan_to_income*state_abbr + loan_to_income * loan_purpose_name + Per_Cap_GDP * CPI + fed_funds_avg_yield, data = HMDA_female_Recession, family = binomial)

# Step 4: Hypothesis Testing
# Get a summary of the model to check p-values
summary(model)
```
again insignificant result for app_raceAsian and app_raceWhite, but significant for state_abbrVA (coefficient - 0.3289, with CA as the reference class) 

VA approval > CA approval
but race not significant any more after replacement applicant_income_000s with loan_to_income and addition of unemployment rate by race and federal funds rate??

But have to do the new EDA
